services:
  api:
    user: 1000:1000
    build:
      context: ../
      dockerfile: Dockerfile
    environment:
      UID: 1000
      GID: 1000
      DOMAIN_CLIENT: https://turbo.motorpresse.de
      DOMAIN_SERVER: https://turbo.motorpresse.de
      DEBUG_LOGGING: false
      DEBUG_CONSOLE: false
      DEBUG_PLUGINS: false
      # We use litellm = (custom)
      ENDPOINTS: agents,custom
      CREDS_KEY: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/CREDS_KEY
      CREDS_IV: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/CREDS_IV
      ALLOW_REGISTRATION: true
      ALLOW_SOCIAL_LOGIN: false
      ALLOW_PASSWORD_RESET: true
      JWT_SECRET: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/JWT_SECRET
      JWT_REFRESH_SECRET: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/JWT_REFRESH_SECRET
      OPENID_GRAPH_SCOPES: ""
      APP_TITLE: "Motorpresse TURBO - Dein Assistent"
      SERPER_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/SERPER_API_KEY
      FIRECRAWL_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/FIRECRAWL_API_KEY
      FIRECRAWL_API_URL: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/FIRECRAWL_API_URL
      JINA_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/JINA_API_KEY
    volumes:
     - librechat-data-images:/app/client/public/images
     - librechat-data-uploads:/app/uploads
     - librechat-data-logs:/app/api/logs
  mongodb:
    user: "999:999"
    volumes:
     - mongodb-data:/data/db
  meilisearch-data-init:
    image: alpine:latest
    user: 0:0
    volumes:
      - meilisearch-data:/meili_data
    command: sh -c "chown -R 1000:1000 /meili_data && chmod -R 755 /meili_data"
    restart: "no"
  meilisearch:
    depends_on:
      meilisearch-data-init:
        condition: service_completed_successfully
    user: 1000:1000
    volumes:
     - meilisearch-data:/meili_data
  vectordb:
    volumes:
     - vectordb-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/POSTGRES_DB
      POSTGRES_USER: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/POSTGRES_USER
      POSTGRES_PASSWORD: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/POSTGRES_PASSWORD
  rag_api:
    environment:
      POSTGRES_DB: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/POSTGRES_DB
      POSTGRES_USER: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/POSTGRES_USER
      POSTGRES_PASSWORD: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/POSTGRES_PASSWORD
      OPENAI_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/OPENAI_API_KEY

 # ADD LITELLM BASIC - NEED TO CONFIGURE litellm-config.yaml, ONLY NEED ENV TO ENABLE REDIS FOR CACHING OR LANGFUSE FOR MONITORING
  litellm:
    build:
       context: ..
       dockerfile_inline: |
         FROM ghcr.io/berriai/litellm:main-latest
         ADD overwrite/files/litellm-config.yaml /app/config.yaml
    ports:
      - "4000:8000"
    command: [ "--config", "/app/config.yaml", "--port", "8000", "--num_workers", "8" ]
    environment:
      OPENAI_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/OPENAI_API_KEY
      ANTHROPIC_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/ANTHROPIC_API_KEY
      MISTRAL_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/MISTRAL_API_KEY
      GEMINI_API_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/GEMINI_API_KEY
      #GOOGLE_APPLICATION_CREDENTIALS: /app/application_default_credentials.json ## only if using Google Vertex
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/REDIS_PASSWORD
      LANGFUSE_PUBLIC_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/LANGFUSE_PUBLIC_KEY
      LANGFUSE_SECRET_KEY: passbolt://d70b4c17-96a0-4485-a1aa-dd3a1e3b7d9f/custom_fields/LANGFUSE_SECRET_KEY
      LANGFUSE_HOST: https://langfuse.ams.to
      NO_DOCS: "True"
      NO_REDOC: "True"

 # ADD LITELLM CACHING
  redis:
    image: redis:7-alpine
    command:
    - sh
    - -c # this is to evaluate the $REDIS_PASSWORD from the env
    - redis-server --appendonly yes --requirepass $$REDIS_PASSWORD ## $$ because of docker-compose
    environment:
      REDIS_PASSWORD: passbolt://13933493-22a2-4075-9d80-b14ec53f6e92/custom_fields/REDIS_PASSWORD
    volumes:
     - redis-data:/data

volumes:
  librechat-data-images:
  librechat-data-uploads:
  librechat-data-logs:
  mongodb-data:
  meilisearch-data:
  vectordb-data:
  redis-data:
